global
    log stdout format raw local0
    maxconn 4096

defaults
    log     global
    mode    http
    option  httplog
    timeout connect 5000ms
    timeout client  50000ms
    timeout server  50000ms

# Frontend that handles both HTTP and HTTPS on port 8000
frontend mixed_protocol
    bind :8000
    mode tcp
    option tcplog
    
    # Wait up to 5s for client to send data
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }
    
    # Route TLS traffic to HTTPS backend
    use_backend https_backend if { req_ssl_hello_type 1 }
    
    # Route everything else (HTTP) to redirect backend
    default_backend http_redirect_backend

# HTTPS backend - proxy to configurable-http-proxy
backend https_backend
    mode tcp
    option tcp-check
    server proxy proxy:8443 check

# HTTP redirect backend - return 301 to HTTPS
backend http_redirect_backend
    mode http
    http-request redirect scheme https code 301
